# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ OAuth - –ò—Ç–æ–≥–∏

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
```
Request had invalid authentication credentials. 
Expected OAuth 2 access token, login cookie or other valid authentication credential.
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ **Firebase ID token** –≤–º–µ—Å—Ç–æ **OAuth 2.0 access token** –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ Google Sheets API.

- **ID token** - –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
- **Access token** - –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google APIs (Sheets, Drive –∏ —Ç.–¥.)

### 2. ‚úÖ –†–µ—à–µ–Ω–∏–µ

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

1. **`contexts/AuthContext.tsx`**
   - ‚úÖ –£–±—Ä–∞–Ω fallback –Ω–∞ `getIdToken()` 
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ OAuth token
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `refreshAccessToken()` (OAuth —Ç–æ–∫–µ–Ω –Ω–µ–ª—å–∑—è –æ–±–Ω–æ–≤–∏—Ç—å)

2. **`utils/authDiagnostics.ts`** (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
   - ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞ (OAuth vs ID token)
   - ‚úÖ –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets API
   - ‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏: `window.authDiagnostics`

3. **`index.tsx`**
   - ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –º–æ–¥—É–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

4. **`README.md`**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫"
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ OAuth

#### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

1. **`–ë–´–°–¢–†–û–ï-–†–ï–®–ï–ù–ò–ï-OAuth.md`**
   - ‚ö° –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ OAuth (5 –º–∏–Ω—É—Ç)
   - üß™ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
   - üî¥ –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

2. **`–ò–ù–°–¢–†–£–ö–¶–ò–Ø-OAuth-Setup.md`**
   - üìò –ü–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
   - üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
   - ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## üöÄ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Google Cloud Console

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://console.cloud.google.com/
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç **metalmaster-erp**
3. –í–∫–ª—é—á–∏—Ç–µ **Google Sheets API**
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ **OAuth consent screen**
5. –î–æ–±–∞–≤—å—Ç–µ scope: `https://www.googleapis.com/auth/spreadsheets`
6. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ —Ä–µ–∂–∏–º Testing)

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [–ë–´–°–¢–†–û–ï-–†–ï–®–ï–ù–ò–ï-OAuth.md](./–ë–´–°–¢–†–û–ï-–†–ï–®–ï–ù–ò–ï-OAuth.md)

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ö–æ–¥

1. –í—ã–π–¥–∏—Ç–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Logout)
2. –û—á–∏—Å—Ç–∏—Ç–µ localStorage:
   ```javascript
   localStorage.clear()
   ```
3. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ Google
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:
   ```
   ‚úÖ OAuth access token –ø–æ–ª—É—á–µ–Ω
   ```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12):
```javascript
window.authDiagnostics.logDiagnostics()
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚úÖ –í–∞–ª–∏–¥–Ω—ã–π OAuth —Ç–æ–∫–µ–Ω
Token type: oauth
Token prefix: ya29....
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –£—Ç–∏–ª–∏—Ç—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:

```javascript
// 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞
window.authDiagnostics.checkToken()

// 2. –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
window.authDiagnostics.logDiagnostics()

// 3. –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Sheets
window.authDiagnostics.testSheetsAccess('–≤–∞—à_spreadsheet_id')

// 4. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã
window.authDiagnostics.clearAuth()

// 5. –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
window.authDiagnostics.showHelp()
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é:

```javascript
const token = localStorage.getItem('google_access_token');
console.log('–¢–æ–∫–µ–Ω:', token ? '‚úÖ' : '‚ùå');
console.log('–¢–∏–ø:', token?.startsWith('ya29.') ? '‚úÖ OAuth' : '‚ùå –ù–µ OAuth');
```

---

## üìä –û—Ç–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | OAuth Access Token ‚úÖ | Firebase ID Token ‚ùå |
|----------|---------------------|---------------------|
| **–§–æ—Ä–º–∞—Ç** | ya29.xxx (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞) | JWT (3 —á–∞—Å—Ç–∏ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É) |
| **–î–ª–∏–Ω–∞** | 100-250 —Å–∏–º–≤–æ–ª–æ–≤ | 500-1000+ —Å–∏–º–≤–æ–ª–æ–≤ |
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | –î–æ—Å—Ç—É–ø –∫ Google APIs | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ Firebase |
| **–†–∞–±–æ—Ç–∞–µ—Ç —Å Sheets API** | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| **–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å** | OAuth authorization flow | `getIdToken()` |
| **–ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å** | ‚ùå –ù–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è reauth) | ‚úÖ –î–∞ |
| **–°—Ä–æ–∫ –∂–∏–∑–Ω–∏** | 1 —á–∞—Å | 1 —á–∞—Å |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **OAuth token –Ω–µ–ª—å–∑—è –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**
   - –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è (1 —á–∞—Å) —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥
   - –≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Firebase Authentication

2. **ID token –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Google APIs**
   - ID token —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –î–ª—è Sheets API –Ω—É–∂–µ–Ω OAuth access token

3. **Scope –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:**
   - –í –∫–æ–¥–µ: `lib/firebase.ts` ‚Üí `googleProvider.addScope()`
   - –í –∫–æ–Ω—Å–æ–ª–∏: OAuth consent screen ‚Üí Scopes

4. **–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ä–µ–∂–∏–º Testing)**
   - –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ Testing, —Ç–æ–ª—å–∫–æ test users –º–æ–≥—É—Ç –≤–æ–π—Ç–∏
   - –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π email –≤ —Å–ø–∏—Å–æ–∫ test users

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç—ã

1. **[–ë–´–°–¢–†–û–ï-–†–ï–®–ï–ù–ò–ï-OAuth.md](./–ë–´–°–¢–†–û–ï-–†–ï–®–ï–ù–ò–ï-OAuth.md)** - –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (5 –º–∏–Ω—É—Ç)
2. **[–ò–ù–°–¢–†–£–ö–¶–ò–Ø-OAuth-Setup.md](./–ò–ù–°–¢–†–£–ö–¶–ò–Ø-OAuth-Setup.md)** - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
3. **[README.md](./README.md)** - –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] Google Sheets API –≤–∫–ª—é—á–µ–Ω –≤ Google Cloud Console
- [ ] OAuth consent screen –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Scope `https://www.googleapis.com/auth/spreadsheets` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] OAuth 2.0 Client ID –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ redirect URIs
- [ ] –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ test user (–µ—Å–ª–∏ —Ä–µ–∂–∏–º Testing)
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω logout ‚Üí clear localStorage ‚Üí login
- [ ] –í –∫–æ–Ω—Å–æ–ª–∏ –≤–∏–¥–Ω–æ: "‚úÖ OAuth access token –ø–æ–ª—É—á–µ–Ω"
- [ ] `window.authDiagnostics.checkToken()` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç type: 'oauth'
- [ ] –¢–æ–∫–µ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "ya29."
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Google Sheets –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üÜò –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:
   ```javascript
   window.authDiagnostics.logDiagnostics()
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞ - –µ—Å–ª–∏ —ç—Ç–æ ID token (JWT), –∑–Ω–∞—á–∏—Ç OAuth –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ OAuth 2.0 Client ID –≤ Google Cloud Console

4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Firebase Console –≤–∫–ª—é—á–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google

5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞

---

**–ì–æ—Ç–æ–≤–æ!** üéâ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å, –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å Google Sheets.






