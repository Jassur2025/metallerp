# üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OAuth –¥–ª—è Google Sheets API

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞: `Request had invalid authentication credentials. Expected OAuth 2 access token...`

**–ü—Ä–∏—á–∏–Ω–∞:** Firebase Authentication –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ ID token (–¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏), –Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets API –Ω—É–∂–µ–Ω OAuth 2.0 access token.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Cloud Console

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Google Cloud Console
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: https://console.cloud.google.com/
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç Firebase: **metalmaster-erp**

### –®–∞–≥ 2: –í–∫–ª—é—á–∏—Ç–µ Google Sheets API
1. –í –º–µ–Ω—é —Å–ª–µ–≤–∞: **APIs & Services** ‚Üí **Library**
2. –ù–∞–π–¥–∏—Ç–µ: **Google Sheets API**
3. –ù–∞–∂–º–∏—Ç–µ **ENABLE** (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ)

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ OAuth Consent Screen
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **APIs & Services** ‚Üí **OAuth consent screen**
2. –ï—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ:
   - **User Type**: External (–¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞) –∏–ª–∏ Internal (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
   - –ù–∞–∂–º–∏—Ç–µ **CREATE**

3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
   - **App name**: MetalMaster ERP
   - **User support email**: –≤–∞—à email
   - **Developer contact information**: –≤–∞—à email
   - –ù–∞–∂–º–∏—Ç–µ **SAVE AND CONTINUE**

4. **–í–ê–ñ–ù–û! –î–æ–±–∞–≤—å—Ç–µ Scopes:**
   - –ù–∞–∂–º–∏—Ç–µ **ADD OR REMOVE SCOPES**
   - –ù–∞–π–¥–∏—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ:
     ```
     https://www.googleapis.com/auth/spreadsheets
     ```
   - –ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞: **Google Sheets API** ‚Üí **`.../auth/spreadsheets`**
   - –ù–∞–∂–º–∏—Ç–µ **UPDATE** ‚Üí **SAVE AND CONTINUE**

5. **Test users** (–µ—Å–ª–∏ —Ä–µ–∂–∏–º "Testing"):
   - –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à Google email –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ù–∞–∂–º–∏—Ç–µ **SAVE AND CONTINUE**

6. –ù–∞–∂–º–∏—Ç–µ **BACK TO DASHBOARD**

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Credentials (OAuth 2.0 Client ID)
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **APIs & Services** ‚Üí **Credentials**
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à **OAuth 2.0 Client ID** (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω Firebase)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. **Authorized JavaScript origins** –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å:
   ```
   http://localhost:5173
   http://localhost:3000
   https://–≤–∞—à-–¥–æ–º–µ–Ω.com
   ```
5. **Authorized redirect URIs** –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å:
   ```
   http://localhost:5173/__/auth/handler
   http://localhost:3000/__/auth/handler
   https://–≤–∞—à-–¥–æ–º–µ–Ω.com/__/auth/handler
   ```
6. –ù–∞–∂–º–∏—Ç–µ **SAVE**

### –®–∞–≥ 5: –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Production (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ **Testing**, —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏.

–î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:
1. **OAuth consent screen** ‚Üí –Ω–∞–∂–º–∏—Ç–µ **PUBLISH APP**
2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** Google –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è sensitive scopes (–≤–∫–ª—é—á–∞—è Sheets API).

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ù–∞–∂–º–∏—Ç–µ **F12** ‚Üí –≤–∫–ª–∞–¥–∫–∞ **Console**
3. –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

**‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å):**
```
‚úÖ OAuth access token –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ redirect
‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ popup —É—Å–ø–µ—à–µ–Ω
```

**‚ùå –û—à–∏–±–∫–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–≤–µ—Ä–Ω—ã):**
```
‚ùå OAuth access token –Ω–µ –ø–æ–ª—É—á–µ–Ω!
‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OAuth consent screen
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞:

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```javascript
const token = localStorage.getItem('google_access_token');
console.log('Token:', token ? 'present' : 'missing');
console.log('Token length:', token?.length); // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–π (> 100 —Å–∏–º–≤–æ–ª–æ–≤)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞
if (token) {
  // OAuth access token –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "ya29."
  console.log('Token prefix:', token.substring(0, 5));
  
  // Firebase ID token - —ç—Ç–æ JWT (3 —á–∞—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∞–º–∏)
  const parts = token.split('.');
  console.log('Token parts:', parts.length); // ID token = 3 —á–∞—Å—Ç–∏, access token = 1 —á–∞—Å—Ç—å
}
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π OAuth access token:**
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `ya29.`
- –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (–Ω–µ JWT)
- –î–ª–∏–Ω–∞ 100-200+ —Å–∏–º–≤–æ–ª–æ–≤

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Firebase ID token (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Sheets API):**
- –§–æ—Ä–º–∞—Ç JWT (3 —á–∞—Å—Ç–∏: header.payload.signature)
- –î–ª–∏–Ω–∞ 500-1000+ —Å–∏–º–≤–æ–ª–æ–≤

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞: "OAuth access token –Ω–µ –ø–æ–ª—É—á–µ–Ω"
**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ scope `https://www.googleapis.com/auth/spreadsheets` –¥–æ–±–∞–≤–ª–µ–Ω –≤ OAuth consent screen
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Google Sheets API –≤–∫–ª—é—á–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –í—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –û—à–∏–±–∫–∞: "Request had invalid authentication credentials"
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Firebase ID token –≤–º–µ—Å—Ç–æ OAuth access token

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞, –∫–∞–∫–æ–π —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—Å–º. –≤—ã—à–µ)
2. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω JWT (3 —á–∞—Å—Ç–∏) - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OAuth –Ω–µ–≤–µ—Ä–Ω—ã
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ OAuth credentials —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º scope

### –û—à–∏–±–∫–∞: "Access blocked: This app's request is invalid"
**–ü—Ä–∏—á–∏–Ω–∞:** OAuth consent screen –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ test user
- –ò–ª–∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (PUBLISH APP)

---

## üìå –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **OAuth access token –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 —á–∞—Å**
   - –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Firebase Auth)

2. **ID token ‚â† Access token**
   - Firebase ID token –Ω—É–∂–µ–Ω –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - OAuth access token –Ω—É–∂–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google APIs (Sheets, Drive –∏ —Ç.–¥.)

3. **Scope –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ**
   - –í –∫–æ–¥–µ: `lib/firebase.ts` —Å—Ç—Ä–æ–∫–∞ 32
   - –í Google Cloud Console: OAuth consent screen ‚Üí Scopes

4. **–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ä–µ–∂–∏–º Testing)**
   - –ú–∞–∫—Å–∏–º—É–º 100 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –¢–æ–ª—å–∫–æ –æ–Ω–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏, –ø–æ–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ

---

## üÜò –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π OAuth 2.0 Client ID:**
   - Credentials ‚Üí CREATE CREDENTIALS ‚Üí OAuth 2.0 Client ID
   - Type: Web application
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ origins –∏ redirect URIs
   - –û–±–Ω–æ–≤–∏—Ç–µ credentials –≤ Firebase Console

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firebase Console:**
   - https://console.firebase.google.com/
   - Authentication ‚Üí Sign-in method ‚Üí Google ‚Üí —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ

3. **–û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –∏ cookies:**
   - –í—ã–π–¥–∏—Ç–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –û—á–∏—Å—Ç–∏—Ç–µ localStorage
   - –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [ ] Google Sheets API –≤–∫–ª—é—á–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ
- [ ] OAuth consent screen –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Scope `https://www.googleapis.com/auth/spreadsheets` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] OAuth 2.0 Client ID –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ redirect URIs
- [ ] –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å–ª–∏ —Ä–µ–∂–∏–º Testing)
- [ ] –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω logout ‚Üí login
- [ ] –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–æ "‚úÖ OAuth access token –ø–æ–ª—É—á–µ–Ω"
- [ ] –¢–æ–∫–µ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "ya29."

---

**–ì–æ—Ç–æ–≤–æ!** –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å. üéâ







